module prometheus-exporter {
    yang-version "1.1";

    // namespace
    namespace "urn:srl_sdk_apps/prometheus-exporter";
    prefix "srl_sdk_apps-prometheus-exporter";

    import srl_nokia-common {
        prefix srl-comm;
    }
    import srl_nokia-system {
        prefix srl-system;
    }
    import srl_nokia-network-instance {
        prefix srl-netinst;
    }
    import srl_nokia-tls {
        prefix srl-tls;
    }
    import srl_nokia-extensions {
        prefix srl-ext;
    }

    // description
    description
        "This module defines configuration and operational state data related to the SRLinux Prometheus Exporter.";

    // revision
    revision "2020-10-15" {
        description
          "prometheus-exporter 0.1.0";
    }
    
    grouping prometheus-exporter-top {
        container prometheus-exporter {
            //presence "prometheus-exporter";
            leaf address {
                type srl-comm:ip-address;
                default "::";
                srl-ext:show-importance high;
                description "IP Address the prometheus exporter server listens on";
            }
            leaf port {
                type srl-comm:port-number;
                default "8888";
                srl-ext:show-importance high;
                description "Port number the prometheus exporter server listens on";
            }
            leaf network-instance {
                type leafref {
                    path "/srl-netinst:network-instance/srl-netinst:name";
                }
                srl-ext:show-importance high;
                default "mgmt";
                description
                    "Reference to a configured network-instance used to send out telemetry updates
                    This network-instance must already exist in the system.";
            }
            leaf tls-profile {
                type leafref {
                    path "/srl-system:system/srl-tls:tls/srl-tls:server-profile/srl-tls:name";
                }
                srl-ext:show-importance high;
                description
                  "Reference to the TLS profile to use on the prometheus server";
            }
            leaf http-path {
                type string;
                default "/metrics";
                srl-ext:show-importance high;
                description "HTTP path the prometheus client needs to scrape to get the metrics";
            }
            leaf admin-state {
                type srl-comm:admin-state;
                default "disable";
                srl-ext:show-importance high;
                description "Administrative state of the exporter";
            }
            leaf oper-state {
                type srl-comm:oper-state;
                config false;
                srl-ext:show-importance high;
                description "Operational state of the exporter";
            }
            list metric {
                description "Predefined metrics to be exposed on the prometheus exporter server";
                key "name";
                leaf name {
                    type enumeration {
                        enum aaa;
                        enum acl;
                        enum bgp;
                        enum interfaces;
                        enum isis;
                        enum lldp;
                        enum mpls;
                        enum network-instance-bridge-table;
                        enum network-instance-icmp;
                        enum network-instance-icmp6;
                        enum platform;
                        enum route-table-ipv4-unicast;
                        enum route-table-ipv6-unicast;  
                        enum subinterfaces;
                        enum tcp;              
                        enum udp;
                    }
                }
                leaf state {
                    type srl-comm:admin-state;
                    default "disable";
                    srl-ext:show-importance high;
                    description "Specifies whether this metric is collected on prometheus client scrapes or not";
                }
                leaf-list paths {
                    config false;
                    max-elements 16;
                    type string;
                    srl-ext:show-importance high;
                    description "gNMI xpaths used to subscribe for updates exposed by this metric";
                }
                leaf help-text {
                    type string;
                    default "SRLinux generated metric";
                    description "Prometheus metric help text";
                }
            } // list metric
            list custom-metric {
                description "User defined prometheus metric";
                key "name";
                leaf name {
                    type string;
                    description "Custom metric name";
                }
                leaf-list paths {
                    max-elements 16;
                    type string;
                    description "gNMI xpaths used to subscribe for updates exposed by this custom metric";
                }
                leaf state {
                    type srl-comm:admin-state;
                    default "disable";
                    srl-ext:show-importance high;
                    description "Specifies whether this metric is collected on prometheus client scrapes or not";
                }
                leaf help-text {
                    type string;
                    default "SRLinux generated metric";
                    description "Prometheus metric help text";
                }
            } // list custom-metric
            leaf scrapes-count {
                config false;
                type srl-comm:zero-based-counter64;
                description "Number of scrapes received by the prometheus server";
            }
            container consul {
                leaf address {
                    type srl-comm:ip-address;
                    srl-ext:show-importance high;
                    description "IP Address of the Consul server to register on";
                }
                leaf port {
                    type srl-comm:port-number;
                    default "8500";
                    srl-ext:show-importance high;
                    description "Port number of the Consul server to register on";
                }
                leaf admin-state {
                    type srl-comm:admin-state;
                    default "disable";
                    srl-ext:show-importance high;
                    description "Administrative state of the Consul registration";
                }
                leaf oper-state {
                    type srl-comm:oper-state;
                    config false;
                    srl-ext:show-importance high;
                    description "Operational state of the Consul registration";
                }
                leaf datacenter {
                    type string;
                    description "Consul datacenter";
                }
                leaf username {
                    type string;
                    description "Consul username";
                }
                leaf password {
                    type string;
                    description "Consul username";
                }
                leaf token {
                    type string;
                    description "Consul Token";
                }
                leaf check-interval {
                    type string;
                    default "5s";
                    description "Consul service check interval";
                }
                leaf max-fail {
                    type int32;
                    default 3;
                    description "Maximum number of failed checks before the service is deleted by Consul";
                }
                leaf service-name {
                    type string;
                    description "Consul service name, defaults to the router hostname appended with `-prometheus`";
                }
                leaf-list tags {
                    type string;
                    description "list of tags to be added to the service registration";
                }
                leaf enable-http-check {
                    type boolean;
                    description "Enable Consul HTTP check";
                }
                leaf http-check-address {
                    type string;
                    description "HTTP address Consul uses for its check, defaults to the exporter address, port and http-path";
                } 
            } // container consul
        } // container prometheus-exporter
    } // grouping prometheus-exporter-top

    augment "/srl-system:system" {
        uses prometheus-exporter-top;
    }
}